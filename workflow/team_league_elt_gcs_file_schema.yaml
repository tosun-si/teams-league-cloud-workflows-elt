#- declare:
#    assign:
#      - resultsList: [ ]
- init:
    assign:
      - project_id: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
      - location_id: "global"
- loadTeamStatsRawToBq:
    call: googleapis.bigquery.v2.jobs.insert
    args:
      projectId: ${project_id}
      body:
        configuration:
          load:
            destinationTable:
              datasetId: "mazlum_test"
              projectId: ${project_id}
              tableId: "team_stat_raw"
            referenceFileSchemaUri: "gs://mazlum_dev/workflows/team_league/schema/team_stats_raw_table_schema.json"
            sourceFormat: "NEWLINE_DELIMITED_JSON"
            sourceUris: "gs://mazlum_dev/workflows/team_league/elt/hot/*.json"
            createDisposition: "CREATE_NEVER"
            writeDisposition: "WRITE_APPEND"
    result: loadTeamStatsRawToBqResult
- runQueryTransformToTeamStatsDomainAndLoadToBQ:
    call: googleapis.bigquery.v2.jobs.query
    args:
      projectId: ${project_id}
      body:
        useLegacySql: false
        query: INSERT INTO `mazlum_test.team_stat`
          (
          teamName,
          teamScore,
          teamSlogan,
          teamTotalGoals,
          topScorerStats,
          bestPasserStats,
          ingestionDate
          )
          SELECT
          team_stats.teamName,
          team_stats.teamScore,
          team_slogan.teamSlogan,
          sum(scorer.goals) as teamTotalGoals,
          ARRAY_AGG(
          STRUCT(
          scorer.scorerFirstName AS firstName,
          scorer.scorerLastName AS lastName,
          scorer.goals AS goals,
          scorer.games AS games
          )
          ORDER BY scorer.goals DESC LIMIT 1
          )[OFFSET(0)] AS topScorerStats,
          ARRAY_AGG(
          STRUCT(
          scorer.scorerFirstName AS firstName,
          scorer.scorerLastName AS lastName,
          scorer.goalAssists AS goalAssists,
          scorer.games AS games
          )
          ORDER BY scorer.goalAssists DESC LIMIT 1
          )[OFFSET(0)] AS bestPasserStats,
          current_timestamp() as ingestionDate
          FROM `mazlum_test.team_stat_raw` team_stats
          INNER JOIN `mazlum_test.team_slogan` team_slogan ON team_stats.teamName = team_slogan.teamName,
          UNNEST(team_stats.scorers) AS scorer
          GROUP BY
          team_stats.teamName,
          team_stats.teamScore,
          team_slogan.teamSlogan;

    result: queryResult
- copyProcessedFilesToColdBucket:
    call: googleapis.cloudbuild.v1.projects.builds.create
    args:
      projectId: ${project_id}
      parent: ${"projects/" + project_id + "/locations/" + location_id}
      body:
        serviceAccount: ${sys.get_env("GOOGLE_CLOUD_SERVICE_ACCOUNT_NAME")}
        options:
          logging: CLOUD_LOGGING_ONLY
        steps:
          - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
            script: gsutil cp gs://mazlum_dev/workflows/team_league/elt/hot/*.json gs://mazlum_dev/workflows/team_league/elt/cold/
    result: resultCloudBuildCopy
- returnResult:
    return: ${resultCloudBuildCopy}